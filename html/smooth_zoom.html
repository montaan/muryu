<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>muryu</title>
    <style type="text/css">
      body {
        margin : 0px;
        padding : 0px;
      }
      #map {
        width: 0px;
        height: 0px;
        position: absolute;
        top: 0px;
        left: 0px;
        background-color: gray;
      }
      #loadStats {
        margin: 0px;
        padding: 5px;
        width: 250px;
        background-color: black;
        color: white;
      }
      #help {
        margin: 0px;
        padding: 5px;
        width: 500px;
        background-color: #e3e6ec;
        color: black;
      }
      h3 {
        margin-top: 0px;
        margin-bottom: 5px;
      }
      h4 {
        margin-top: 15px;
        margin-bottom: 2px;
      }
      p {
        margin-top: 1px;
        margin-bottom: 4px;
      }
      .tile {
        border: 0px;
      }
    </style>
    <link rel="stylesheet" href="scripts/desk_js/style.css"></link>
    <script type="text/javascript" src="scripts/desk_js/prototype.js"></script>
    <script type="text/javascript" src="scripts/desk_js/soundmanager2.js"></script>
    <script type="text/javascript" src="scripts/desk_js/desk.js"></script>
    <script type="text/javascript" src="scripts/zogen/TileMap.js"></script>
    <script type="text/javascript" src="scripts/zogen/Editors.js"></script>
    <script>
      // <![CDATA[
      window.addEventListener("load", function(ev){
        Session.storage = {
          load : function() {
            var t = this
            new Ajax.Request('/users/json', {
              method : 'get',
              asynchronous : false,
              onSuccess : function(res) {
                t.info = res.responseText.evalJSON()
              }
            })
          },
          
          getItem : function(name) {
            var item = this.info.preferences[name]
            return (item ? {key: name, value: item} : undefined)
          },
          
          setItem : function(name, value) {
            var params = {}
            params[name] = value
            new Ajax.Request('/users/set_preferences', { parameters : params })
          },

          removeItem : function(name) {
            var params = {}
            params[name] = true
            new Ajax.Request('/users/delete_preferences', { parameters : params })
          }
        }
        Session.storage.load()
        
        var qvars = document.location.search.slice(1).split("&")
        var query = {}
        qvars.each(function(q){ var p = q.split("="); query[p[0]] = p[1] })
        var prefs = Session.storage.info.preferences
        if (prefs.addons && prefs.addons.length > 0 && (query.disable_addons == undefined)) {
          var addons = prefs.addons.split(";")
          for(var i=0; i<addons.length; i++) {
            Object.require(addons[i])
          }
        }

        var map = document.getElementById("map")
        Desk.Windows.setContainer(map)
        map.style.width = window.innerWidth + 'px'
        map.style.height = window.innerHeight + 'px'
        setInterval(function(){
          if (window.innerWidth != Desk.Windows.previousInnerWidth ||
              window.innerHeight != Desk.Windows.previousInnerHeight) {
            map.style.width = window.innerWidth + 'px'
            map.style.height = window.innerHeight + 'px'
            Desk.Windows.previousInnerWidth = window.innerWidth
            Desk.Windows.previousInnerHeight = window.innerHeight
          }
        }, 100)
        menu = new Desk.Menu()
        menu.addTitle('Windows')
        menu.addItem('Collapse all groups', function() {
          Desk.Windows.taskbar.setCollapsedForAll(true)
        }, 'icons/CollapseAllGroups.png')
        menu.addItem('Expand all groups', function() {
          Desk.Windows.taskbar.setCollapsedForAll(false)
        }, 'icons/ExpandAllGroups.png')
        menu.addSeparator()
        menu.addItem('Add Panel', function(){ new Desk.Panel() })
        menu.addTitle('Session')
        menu.addItem('Save Session', function(){ Session.save() })
        menu.addItem('Clear Session', function(){ Session.clear() })
        Desk.Windows.windowContainer.addEventListener('click', function(e){
          if (Event.isLeftClick(e) && e.ctrlKey) {
            menu.show(e)
            Event.stop(e)
          }
        }, false)
        if (!Session.load()) {
          var panel = new Desk.Panel('left')
          panel.addApplet(Applets.Taskbar())
          Map = new TileMap({
            x:50, y: 50,
            width: window.innerWidth,
            height: window.innerHeight
          })
          var topPanel = new Desk.Panel('top')
          topPanel.addApplet(Applets.Session())
          new Desk.Window('/help.html', {x:200, y:10})
        }
        if (false) { // start instrumentation block
          var load_buf = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
          var req_buf = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
          var last_reqs = 0
          var last_loads = 0
          var max_rps = 0
          var max_lps = 0
          var ls = E('pre', null, 'loadStats')
          ls.style.display = 'block'
          var statWindow = false
          var windows = Desk.Windows.windows
          for (var i=0; i<windows.length; i++) {
            var w = windows[i]
            if (w.title == 'stats') {
              statWindow = w
              break
            }
          }
          if (statWindow)
            statWindow.setContent(ls)
          else
            new Desk.Window(ls, {title:"stats", x: 750, y: 10})
          var updatesPerSec = 5
          var start_time = new Date().getTime()
          setInterval(function(){
            req_buf.shift()
            load_buf.shift()
            req_buf.push(Map.loader.totalCompletes - last_reqs)
            load_buf.push(Map.loader.totalLoads - last_loads)
            last_reqs = Map.loader.totalCompletes
            last_loads = Map.loader.totalLoads
            var reqs = 0
            var loads = 0
            for (var i=0; i<req_buf.length; i++) reqs += req_buf[i]
            for (var i=0; i<load_buf.length; i++) loads += load_buf[i]
            var rps = updatesPerSec * reqs / req_buf.length
            var lps = updatesPerSec * loads / load_buf.length
            if (rps > max_rps) max_rps = rps
            if (lps > max_lps) max_lps = lps
            var bw = rps * 0.125 + ' Mbps'
            var max_bw = max_rps * 0.125 + ' Mbps'
            var total_bw = Map.loader.totalLoads * 0.125
            var avg_bw = total_bw / ((new Date().getTime() - start_time) * 0.001)
            ls.innerHTML = [
              "         requests: " + Map.loader.totalRequests,
              "          cancels: " + Map.loader.totalCancels,
              "            loads: " + Map.loader.totalLoads,
              "        completed: " + Map.loader.totalCompletes,
              "       load ratio: " + parseInt(100*(Map.loader.totalLoads / Map.loader.totalRequests)) / 100,
              " completion ratio: " + parseInt(100*(Map.loader.totalCompletes / Map.loader.totalLoads)) / 100,
              " pending requests: " + Map.loader.queue.queue.length,
              "        loads/sec: " + lps,
              "    completes/sec: " + rps,
              "    bandwidth use: " + bw,
              "    max loads/sec: " + max_lps,
              "max completes/sec: " + max_rps,
              "    bandwidth max: " + max_bw,
              "average bandwidth: " + parseInt(100*avg_bw) / 100 + 'Mbps',
              "  total bandwidth: " + parseInt(100*total_bw) / 100 + 'Mb',
              "              fps: " + parseInt(100*Map.fps) / 100,
              "      average fps: " + parseInt(100*Map.avgFps) / 100
            ].join("\n")
          }, 1000/updatesPerSec)
        } // end instrumentation block
      }, false)
      // ]]>
    </script>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>

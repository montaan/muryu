<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>zogen</title>
    <style>
      #currentLocation {
        z-index: 10;
        position:absolute;
        left: 0px;
        top: 0px;
        height: 16px;
        width: 100%;
        padding-bottom: 2px;
        padding-top: 0px;
        background: black;
        color: #99969B;
        text-indent: 2px;
      }
      #currentLocation a {
        color: #99969B;
      }
      input { display:block; }
      img { display:block; }
      #zogen {
        position:absolute;
        background: #33363B;
        left:0px;
        top: 18px;
        width: 700px;
        height: 600px;
        overflow:hidden;
      }
      #zogen-s1 {
        position:absolute;
        background: #33363B;
        left:702px;
        top: 0px;
        width: 256px;
        height: 255px;
        overflow:hidden;
      }
      #zogen-s2 {
        position:absolute;
        background: #33363B;
        left:702px;
        top: 257px;
        width: 256px;
        height: 255px;
        overflow:hidden;
      }
      #status {
        position:absolute;
        color: #000000;
        top: 10px;
        left: 522px;
      }
      #midPoint{
        position:absolute;
        background: red;
        width: 10px;
        height: 10px;
        top: 0px;
        left: 0px;
        z-index:10;
      }
      .infoLayer {
        display: none;
        background: url(/zogen/50_opacity_black.png);
        position: absolute;
        z-index: 8;
        padding: 4px;
        margin-left: 5px;
        margin-top: 10px;
        color: white;
        font-family: URW Gothic L;
        font-weight: bold;
        font-size: 10px;
      }
      .infoLayer h3 {
        margin-top: 0px;
        margin-bottom: 6px;
      }
      .infoLayer img {
        vertical-align: middle;
      }
      .infoLayer div {
        background: url(/zogen/80_opacity_black.png);
      }
      .infoText {
        background: url(/zogen/50_opacity_black.png);
        position: absolute;
        z-index: 7;
        color: white;
        font-family: URW Gothic L;
        font-weight: bold;
        font-size: 10px;
        overflow: hidden;
      }
      .infoLink {
        color: white;
        margin-left: 4px;
      }
      .info {
        position: absolute;
        z-index: 6;
      }
      .itemLink {
        display: block;
        position: absolute;
      }
    </style>
    <script src="rototype.js"></script>
    <script>
      Portal = function(config) {
        this.mergeD(config)
        var t = this
        postQuery(this.tileInfoURL, '',
          function(res){
            eval("var obj = " + res.responseText)
            t.mergeD(obj)
            t.init()
          }
        )
      }
      
      Portal.prototype = {
        x : -20,
        y : -60,
        zoom : 2,
        maxZoom : 7,
        tileSize : 256,
        title : 'zogen',
        loadLinks : true,
        createLinks : true,
        tileURL : '/tile/',
        tileInfoURL : '/tile_info/',
        itemInfoURL : '/items/',
        itemInfoSuffix : '',
        query : '?' + window.location.search.substring(1),

        init : function() {
          this.tiles = {tilesInCache : 0}
          this.initView()
          this.container.appendChild(this.view)
          this.updateTiles()
          this.container.addEventListener("mousedown", this.bind('mousedownHandler'), false)
          this.container.addEventListener("DOMMouseScroll", this.bind('DOMMouseScrollHandler'), false)
          this.container.addEventListener("keypress", this.bind('keyHandler'), false)
          window.addEventListener("mousemove", this.bind('mousemoveHandler'), false)
          window.addEventListener("mouseup", this.bind('mouseupHandler'), false)
          this.infoLayer = Elem('div', null, null, 'infoLayer')
          this.view.appendChild(this.infoLayer)
        },
        
        initView : function(){
          var v = Elem('div')
          v.style.position = 'absolute'
          v.left = -this.x
          v.top = -this.y
          v.style.left = v.left + 'px'
          v.style.top = v.top + 'px'
          v.cX = this.container.offsetWidth/2
          v.cY = this.container.offsetHeight/2
          var t = Elem('h2', this.title)
          t.style.mergeD({
            position: 'absolute',
            fontSize: '20px',
            left: '0px', top: '-40px',
            zIndex: 4, color: 'white'
          })
          this.titleElem = t
          v.appendChild(t)
          this.view = v
        },

        updateTiles : function(zoomed){
          var t = this
          var v = this.view
          var c = this.container
          var sl = -(v.left - (v.left % t.tileSize))
          var st = -(v.top - (v.top % t.tileSize))
          this.x = -v.left
          this.y = -v.top
          this.currentLocation.href = "#x" + this.x + "y" + this.y + "z" + this.zoom
          var tile_coords = []
          var visible_tiles = 0
          var midX = c.offsetWidth/2 - v.left - t.tileSize / 2
          var midY = c.offsetHeight/2 - v.top - t.tileSize / 2
          this.titleElem.style.fontSize = parseInt(10 * Math.pow(2, this.zoom)) + 'px'
          this.titleElem.style.top = parseInt(-20 * Math.pow(2, this.zoom)) + 'px'
          Rg(-1, c.offsetWidth/t.tileSize+1).each(function(i){
            var x = i*t.tileSize+sl
            var dx = Math.abs(x - midX)
            Rg(-1, c.offsetHeight/t.tileSize+1).each(function(j){
              var y = j*t.tileSize+st
              var dy = Math.abs(y - midY)
              var d = Math.sqrt(dx*dx + dy*dy)
              t.showTile(x,y, d)
              visible_tiles++
            })
          })
          if (t.tiles.tilesInCache > visible_tiles*2 || zoomed) {
            t.removeTiles(sl - t.tileSize,
                          st - t.tileSize,
                          sl + c.offsetWidth + t.tileSize,
                          st + c.offsetHeight + t.tileSize)
          }
        },
        
        removeTiles : function(left, top, right, bottom){
          for (var i in this.tiles) {
            if (i.match(/:/)) {
              var xy = i.split(":")
              var x = parseInt(xy[0])
              var y = parseInt(xy[1])
              var zoom = parseInt(xy[2])
              if (zoom != this.zoom ||
                  x < left || x > right || y < top || y > bottom)
              {
                if (this.tiles[i].timeout) clearTimeout(this.tiles[i].timeout)
                try{ this.view.removeChild(this.tiles[i].parentNode) } catch(e) {}
                this.tiles[i].src = null
                this.tiles.tilesInCache--
                delete this.tiles[i]
              }
            }
          }
        },

        showTile : function(x, y, priority){
          if (!this.tiles[x+':'+y+':'+this.zoom]) {
            var tile = Elem('img',null,null,'tile')
            tile.style.position = 'absolute'
            tile.style.left = '0px'
            tile.style.top = '0px'
            this.tiles[x+':'+y+':'+this.zoom] = tile
            this.tiles.tilesInCache++
            tile.timeout = setTimeout(this.bind(function(){
              tile.style.visibility = 'hidden'
              var t = this
              var tileQuery = 'x'+ x +'y'+ y +'z'+ this.zoom +
                         'w'+ this.tileSize +'h'+ this.tileSize
              var tile_cont = Elem('div')
              tile_cont.style.position = 'absolute'
              tile_cont.style.left = x+'px'
              tile_cont.style.top = y+'px'
              tile.addEventListener("load",
                function(){
                  this.style.visibility = 'visible'
                  if (t.zoom >= 5 && t.loadLinks) {
                    postQuery(t.tileInfoURL + tileQuery, t.query,
                      function(res){
                        tile.info = eval(res.responseText)
                        /*
                          Instead of many links, switch to fast (but complex)
                          mouse-following link system. Put tile infos into
                          grid-indexed 2D array, modulo mouse coords to grid
                          coords.

                          At far detail (64x64 and 128x128), bake
                          the emblems and item texts into the tiles.
                          Text seems to be the slowest thing to draw.
                          ( this is also true for server-side drawing :| )

                          Why?
                            Firefox doesn't like moving elements around,
                            so minimizing the amount of stuff it does need to
                            move makes the whole thing snappier.
                          
                          init:
                            itemCoords = {}
                            itemCoords[info.x] ||= {}
                            itemCoords[info.x][info.y] ||= newLink(info)

                          mousemove:
                            col = itemCoords[mouse_x - (mouse_x % sz)]
                            if (col) item = col[mouse_y - (mouse_y % sz)]
                            itemLink.href = "/files/" + item.path
                        */
                        tile.info.each(function(i){
                          if (!t.createLinks) return false
                          var ti = Elem('a', null, null, 'itemLink')
                          ti.style.left = i[1][0][0] + 'px'
                          ti.style.top = i[1][0][1] + 'px'
                          ti.style.width = i[1][0][2] + 'px'
                          ti.style.height = i[1][0][2] + 'px'
                          ti.href = "/files/" + i[1][1].path
                          ti.emblems = []
                          ti.infoObj = i
                          ti.addEventListener("click", t.linkClick(), false)
                          ti.addEventListener("mousedown", t.linkDown, false)
                          ti.style.zIndex = 2
                          if (t.zoom == 7) {
                            var info = ti.info = Elem('div', null, null, 'info')
                            info.style.mergeD({
                              left: ti.style.left,
                              top: ti.style.top
                            })
                            var info_text = Elem('div', null, null, 'infoText')
                            info_text.style.mergeD({
                              left: ti.style.left,
                              top: (parseInt(ti.style.top) + parseInt(ti.style.height) - 16) + 'px',
                              width: ti.style.width,
                              height: '16px'
                            })
                            info_text.innerHTML = ti.infoObj[1][1].path.split("/").last()
                            var emblems = [
                              ['e', 'FUNNY HATS!! - £4.99 from eBay.co.uk'],
                              ['euro', 'Rocket Ship - 8.49€ from Amazon.de'],
                              ['location', 'Bavaria, Germania']]
                            emblems.each(function(n){
                              if (Math.random() < 0.7) return
                              ti.emblems.push(n)
                              var el = Elem('img')
                              el.style.display = 'block'
                              el.src = '/zogen/' + n[0] + '_16.png'
                              el.style.margin = '1px'
                              info.appendChild(el)
                            })
                          }
                          try{
                            tile_cont.appendChild(ti)
                            tile_cont.appendChild(info)
                            tile_cont.appendChild(info_text)
                          } catch(e) {}
                        })
                      }
                    )
                  }
                },
              false)
              tile_cont.appendChild(tile)
              this.view.appendChild(tile_cont)
              tile.width = this.tileSize
              tile.height = this.tileSize
              tile.src = this.tileURL + tileQuery + this.query
              tile.timeout = false
            }), priority/40)
          }
        },

        linkDown : function(e) {
          this.downX = e.clientX
          this.downY = e.clientY
        },

        linkClick : function() {
          var t = this
          return function(e) {
            if (e.button == 0 && !(e.ctrlKey || e.altKey || e.shiftKey)) {
              e.preventDefault()
              if ((Math.abs(e.clientX - this.downX) > 3) &&
                  (Math.abs(e.clientY - this.downY) > 3)) {
                return false
              }
              if (!this.fullInfo) {
                var th = this
                var x = e.layerX + parseInt(this.style.left) + parseInt(this.parentNode.style.left)
                var y = e.layerY + parseInt(this.style.top) + parseInt(this.parentNode.style.top)
                postQuery(t.itemInfoURL + this.infoObj[1][1].path + t.itemInfoSuffix, '',
                  function(res) {
                    eval("var obj = " + res.responseText)
                    th.fullInfo = obj.merge({emblems: th.emblems})
                    t.showInfoLayer(x, y, th.fullInfo)
                  }
                )
              } else if (t.infoLayerData != this.fullInfo){
                var x = e.layerX + parseInt(this.style.left) + parseInt(this.parentNode.style.left)
                var y = e.layerY + parseInt(this.style.top) + parseInt(this.parentNode.style.top)
                t.showInfoLayer(x, y, this.fullInfo)
              } else {
                t.hideInfoLayer()
              }
              return false
            }
          }
        },

        showInfoLayer : function(x,y,info) {
          this.infoLayerData = info
          var infoLayer = this.infoLayer
          this.infoLayer.innerHTML = ''
          this.infoLayer.appendChild(Elem('h3', info.path))
          info.emblems.each(function(n){
            var d = Elem('div')
            var a = Elem('a', n[1], null, 'infoLink')
            a.href = n[1]
            var el = Elem('img')
            el.style.display = 'inline'
            el.src = '/zogen/' + n[0] + '_32.png'
            d.appendChild(el)
            d.appendChild(a)
            infoLayer.appendChild(d)
          })
          var i = Elem('img')
          i.src = '/files/' + info.path
          this.infoLayer.appendChild(i)
          this.infoLayer.style.left = x + 'px'
          this.infoLayer.style.top = y + 'px'
          this.infoLayer.style.display = 'block'
        },

        hideInfoLayer : function() {
          this.infoLayerData = false
          this.infoLayer.style.display = 'none'
        },
        
        pan : function(x,y,e){
          this.view.left += x
          this.view.top += y
          this.updateTiles()
          this.view.style.left = this.view.left + 'px'
          this.view.style.top = this.view.top + 'px'
          if (e && e.preventDefault) e.preventDefault()
        },
        
        zoomOut : function(e){
          if (this.zoom > 0) {
            var lx = this.view.cX - this.view.left - parseInt(this.container.computedStyle().left)
            var ly = this.view.cY - this.view.top - parseInt(this.container.computedStyle().top)
            this.zoom--
            this.view.left += parseInt(lx / 2)
            this.view.top += parseInt(ly / 2)
            if(this.zoomTimeout) clearTimeout(this.zoomTimeout)
            this.zoomTimeout = setTimeout(this.bind(function(){
              this.view.style.left = this.view.left + 'px'
              this.view.style.top = this.view.top + 'px'
              this.updateTiles(true)
            }), 200)
          }
          if (e && e.preventDefault) e.preventDefault()
        },
        
        zoomIn : function(e){
          if (this.zoom < this.maxZoom) {
            var lx = this.view.cX - this.view.left - parseInt(this.container.computedStyle().left)
            var ly = this.view.cY - this.view.top - parseInt(this.container.computedStyle().top)
            this.zoom++
            this.view.left -= (lx)
            this.view.top -= (ly)
            if(this.zoomTimeout) clearTimeout(this.zoomTimeout)
            this.zoomTimeout = setTimeout(this.bind(function(){
              this.view.style.left = this.view.left + 'px'
              this.view.style.top = this.view.top + 'px'
              this.updateTiles(true)
            }), 200)
          }
          if (e && e.preventDefault) e.preventDefault()
        },
        
        mousedownHandler : function(e){
          this.dragging = true
          this.dragX = e.clientX
          this.dragY = e.clientY
          this.container.focus()
          e.preventDefault()
        },

        mousemoveHandler : function(e){
          this.view.cX = e.clientX
          this.view.cY = e.clientY
          if (this.dragging) {
            this.pan(e.clientX-this.dragX, e.clientY-this.dragY)
            this.dragX = e.clientX
            this.dragY = e.clientY
          }
        },

        mouseupHandler : function(e){
          this.dragging = false
        },
        
        DOMMouseScrollHandler : function(e){
          if (e.detail > 0 ) {
            this.zoomOut(e)
          } else {
            this.zoomIn(e)
          }
        },

        keyHandler : function(e){
          switch(e.charCode | e.keyCode){
            case 90:
            case 122:
              this.zoomIn(e)
              break
            case 88:
            case 120:
              this.zoomOut(e)
              break
            case 37:
              this.pan(64,0,e)
              break
            case 38:
              this.pan(0,64,e)
              break
            case 39:
              this.pan(-64,0,e)
              break
            case 40:
              this.pan(0,-64,e)
              break
          }
        }
      }
    </script>
    
    <script>
      window.addEventListener("load",function(){
        $('zogen').style.width = window.innerWidth - parseInt($('zogen').computedStyle().left) + 'px'
        $('zogen').style.height = window.innerHeight - parseInt($('zogen').computedStyle().top) + 'px'
        var config = {
          container: $('zogen'),
          currentLocation : $('currentLocationLink'),
          tileURL : '/tile/',
          tileInfoURL : '/tile_info/',
          itemInfoURL : '/items/', itemInfoSuffix : '/json'
        }
        var xyz = document.location.hash.split(/[xyz]/)
        if (xyz[1] && xyz[1].match(/^[-+]?[0-9]+$/)) config.x = parseInt(xyz[1])
        if (xyz[2] && xyz[2].match(/^[-+]?[0-9]+$/)) config.y = parseInt(xyz[2])
        if (xyz[3] && xyz[3].match(/^[0-9]+$/)) config.zoom = parseInt(xyz[3])
        var z = window.zogen = new Portal(config)
        window.onkeypress = function(e){ z.keyHandler(e) }
        window.onresize = function(){
          z.container.style.width = window.innerWidth - parseInt(z.container.computedStyle().left) + 'px'
          z.container.style.height = window.innerHeight - parseInt(z.container.computedStyle().top) + 'px'
          z.updateTiles()
        }
      },false)

      function toggleCSSDisplay(selector) {
        var s = $S(selector)
        var d = s.style.display
        if (d && d == 'none') {
          s.style.display = 'block'
        } else {
          s.style.display = 'none'
        }
      }
    </script>
  </head>

  <body>
    <div id="currentLocation">
      <a id="currentLocationLink" href="zogen.html#x0y0z2">Link here</a>
      | Toggle [
        <a href="javascript:void(window.zogen.loadLinks = !window.zogen.loadLinks)">info loading</a>
      | <a href="javascript:void(window.zogen.createLinks = !window.zogen.createLinks)">info element creation</a>
      | <a href="javascript:toggleCSSDisplay('.info')">emblems</a>
      | <a href="javascript:toggleCSSDisplay('.infoText')">filename</a>
      | <a href="javascript:toggleCSSDisplay('.itemLink')">links</a> ]
    </div>
    <div id="zogen">
    </div>
  </body>

</html>

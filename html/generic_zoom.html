<html>
  <head>
    <style>
      div.MapBackground {
        border : 1px solid blue;
      }
      div.PortalBackground {
        border : 1px solid white;
      }
      div.TitledPortal {
        border : 1px solid green;
      }
      div.PortalMap {
        border : 1px solid yellow;
      }
      div.Title {
        border : 1px solid red;
      }
    </style>
  
  
    <script type="text/javascript" src="/scripts/desk_js/prototype.js"></script>
    <script type="text/javascript" src="/scripts/desk_js/scriptaculous.js"></script>
    <script type="text/javascript" src="/scripts/desk_js/desk.js"></script>
    <script type="text/javascript" src="/scripts/slideshow.js"></script>
    <script type="text/javascript" src="/scripts/zogen/PortalMap.js"></script>
    <script type="text/javascript">
    
      String.prototype.unfilterJSON = function() {
        if (this.slice(0,8) == 'while(0)') {
          return this.slice(9,-1)
        } else {
          return this
        }
      }

      Session.storage = {
        load : function(callback) {
          var t = this
          new Ajax.Request('/users/json', {
            method : 'get',
            asynchronous : false,
            onSuccess : function(res) {
              t.info = res.responseText.evalJSON()
              callback()
            }
          })
        },
        
        getItem : function(name) {
          var item = undefined
          try { item = this.info.preferences[name] } catch(e) {}
          return (item ? {key: name, value: item} : undefined)
        },
        
        setItem : function(name, value) {
          var params = {}
          params[name] = value
          new Ajax.Request('/users/set_preferences', { asynchronous : false, parameters : params })
        },

        removeItem : function(name) {
          var params = {}
          params[name] = true
          new Ajax.Request('/users/delete_preferences', { asynchronous : false, parameters : params })
        }
      }
      
      Muryu = {
        login : function() {
          var loggedIn = (Session.storage.info.name && Session.storage.info.name != 'anonymous')
          if (loggedIn) {
            if (Session.storage.info.preferences.language)
              Tr.language = Session.storage.info.preferences.language
            Ajax.Request.prototype.initialize = function(url, options) {
              this.transport = Ajax.getTransport()
              if (!options.method || options.method.toLowerCase() == 'post') {
                var secret = {secret : Session.storage.info.secret}
                if (options.parameters) {
                  if (typeof options.parameters == 'object') {
                    Object.extend(options.parameters, secret)
                  } else {
                    options.parameters = options.parameters.toString()+"&secret="+secret.secret
                  }
                } else {
                  options.parameters = secret
                }
              }
              this.setOptions(options)
              this.request(url)
            }
          }
        },
        
        init : function(){
          var loggedIn = this.login()
          
          var qvars = document.location.search.slice(1).split("&")
          var query = {}
          qvars.each(function(q){ var p = q.split("="); query[p[0]] = p[1] })
          var prefs = Session.storage.info.preferences
          if (prefs && prefs.addons && prefs.addons.length > 0 && (query.disable_addons == undefined)) {
            var addons = prefs.addons.split(";")
            for(var i=0; i<addons.length; i++) {
              Object.require(addons[i])
            }
          }
  
          var map = document.getElementById("map")
          Desk.Windows.setContainer(map)
          map.style.width = window.innerWidth + 'px'
          map.style.height = window.innerHeight + 'px'
          setInterval(function(){
            if (window.innerWidth != Desk.Windows.previousInnerWidth ||
                window.innerHeight != Desk.Windows.previousInnerHeight) {
              map.style.width = window.innerWidth + 'px'
              map.style.height = window.innerHeight + 'px'
              Desk.Windows.previousInnerWidth = window.innerWidth
              Desk.Windows.previousInnerHeight = window.innerHeight
            }
          }, 100)
          Tr.addTranslations('fi-FI', {
            'Workspace' : 'Työtila',
            'Add search' : 'Lisää haku',
            'Windows' : 'Ikkunat',
            'Collapse all groups' : 'Piilota kaikki ryhmät',
            'Expand all groups' : 'Laajenna kaikki ryhmät',
            'Utilities' : 'Työkalut',
            'Make note' : 'Tee muistiinpano',
            'Session' : 'Istunto',
            'Save Session' : 'Tallenna istunto',
            'Clear Session' : 'Nollaa asetukset',
            'Note' : 'Muistiinpano ',
            'help.html' : 'help.html',
            'help' : 'Apua'
          })
          Tr.addTranslations('en-US', {
            'Note' : 'Note '
          })
          Tr.addTranslations('ja-JP', {
            'Date' : function(d){
              weekdays = ['日', '月', '火', '水', '木', '金', '土']
              months = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '十一', '十二']
              return ((d.getYear() + 1900) + '年' +
                      (d.getMonth() + 1) + '月' +
                      d.getDate() + '日' +
                      ' ('+ weekdays[d.getDay()] + ') ' +
                      d.getHours().toString().rjust(2, '0') + ':' +
                      d.getMinutes().toString().rjust(2, '0') + ':' +
                      d.getSeconds().toString().rjust(2, '0'))
            },
            'Workspace' : '作業領域',
            'Add search' : '検索を追加する',
            'Windows' : '窓',
            'Collapse all groups' : '全グループを隠す',
            'Expand all groups' : '全グループを広げる',
            'Utilities' : '道具',
            'Make note' : '覚書',
            'Session' : 'セッション',
            'Save Session' : 'セッションを保管する',
            'Clear Session' : 'セッションを消す',
            'Note' : '覚書 ',
            'help.html' : 'help.html',
            'help' : '使用法'
          })
          Tr.translations['fi'] = Tr.translations['fi-FI']
          menu = new Desk.Menu()
          menu.addTitle(Tr('Workspace'))
          var q = ""
          if (loggedIn)
            q += "user:"+Session.storage.info.name+" " 
          q += "sort:date"
          menu.addItem(Tr('Add search'), function() {
            var ns = new TileMap({
              isSubmap : true,
              query: q,
              bgcolor: Map.bgcolor,
              left: Math.pow(2,-Map.targetZ)*(Map.pointerX-Map.x),
              top: Math.pow(2,-Map.targetZ)*(Map.pointerY-Map.y),
              width: 256,
              height: 256
            }).setParent(Map)
          })
          if (loggedIn) {
            menu.addTitle(Tr('Utilities'))
            menu.addItem(Tr('Make note'), function(){ new Desk.Window('app:Notes.make') })
          }
          menu.addTitle(Tr('Windows'))
          menu.addItem(Tr('Collapse all groups'), function() {
            Desk.Windows.taskbar.setCollapsedForAll(true)
          }, 'icons/CollapseAllGroups.png')
          menu.addItem(Tr('Expand all groups'), function() {
            Desk.Windows.taskbar.setCollapsedForAll(false)
          }, 'icons/ExpandAllGroups.png')
  //         menu.addSeparator()
  //         menu.addItem(Tr('Add Panel'), function(){ new Desk.Panel() })
          menu.addTitle(Tr('Session'))
  //         menu.addItem(Tr('Save Session'), function(){ Session.save() })
          menu.addItem(Tr('Clear Session'), function(){ Session.clear() })
          menu.addItem(Tr('Applets.Session.LogOut'), function(){ location.href = '/users/logout' })
          menu.bind(Desk.Windows.windowContainer)
          if (!Session.load()) {
            Map = new TileMap({
              x:50, y: 50,
              z: 1,
              width: window.innerWidth,
              height: window.innerHeight,
              noTiles: true
            })
            new TileMap({
              isSubmap : true,
              query: q,
              left: 0,
              top: 0,
              width: 256,
              height: 256
            }).setParent(Map)
            var types = ['audio','video','pdf|postscript','html','image']
            var i = 0
            types.each(
            function(e) {
              new TileMap({
                isSubmap : true,
                left : 220,
                top : i*32,
                width: 256,
                color: 'false',
                height: e == 'image' ? 256 : 32,
                query : 'type:'+e+" "+q
              }).setParent(Map)
              i++
            })
            var topPanel = new Desk.Panel('left', {movable : false})
            topPanel.addApplet(Applets.Session())
            topPanel.addApplet(Applets.MusicPlayer())
            topPanel.addApplet(Applets.Sets())
            topPanel.addApplet(Applets.Groups())
            topPanel.addApplet(Applets.Taskbar())
            new Desk.Window(Tr('help.html'), {x: 800, y: 10, group: Tr('help')})
          }
          $('while_loading').detachSelf()
        }
      }
      
      window.addEventListener('load', function() {
        Session.storage.load(Muryu.login.bind(Muryu))
        document.body.style.overflow = 'hidden'
        var container = E('div')
        container.style.position = 'absolute'
        var debug = false
        if (debug) {
          container.style.top = '200px'
          container.style.left = '200px'
          container.width = 256
          container.height = 256
          container.style.width = container.width + 'px'
          container.style.height = container.height + 'px'
          var c = E('div',null,null,null, container.style)
          c.style.border = '1px solid red'
          c.style.top = '-1'
          c.style.left = '-1'
          c.style.zIndex = 1000
          container.appendChild(c)
        } else {
          container.style.left = '0px'
          container.style.top = '0px'
          container.style.width = '100%'
          container.style.height = '100%'
          container.width = document.body.clientWidth
          container.height = document.body.clientHeight
        }
        var txt = E('div')
        txt.style.position = 'absolute'
        txt.style.left = '280px'
        txt.style.width = '200px'
        txt.style.color = 'white'
        txt.style.zIndex = 1000
        container.appendChild(txt)
        document.body.appendChild(container)
        document.body.style.overflow = 'hidden'
        topmap = new Portal({
          container: container
        })
        down = false
        downX = 0
        downY = 0
        window.addEventListener('click', function(){window.focus()}, false)
        window.addEventListener('DOMMouseScroll', function(ev) {
          var x = downX
          var y = downY
          var dx = x - topmap.container.offsetLeft
          var dy = y - topmap.container.offsetTop
          topmap.animatedZoom( topmap.z - (ev.detail > 0 ? 1 : -1), dx, dy )
          Event.stop(ev)
        }, false)
        window.addEventListener('keydown', function(ev) {
          var x = downX
          var y = downY
          var dx = x - topmap.container.offsetLeft
          var dy = y - topmap.container.offsetTop
          var k = ev.charCode | ev.keyCode
          var s = String.fromCharCode(k).toLowerCase()
          if (s == 't') {
            topmap.zoomIn = true
            topmap.animatedZoom( topmap.z + 1, dx, dy )
          } else if (s == 'g') {
            topmap.zoomOut = true
            topmap.animatedZoom( topmap.z - 1, dx, dy )
          }
//           Event.stop(ev)
        }, false)
        window.addEventListener('keyup', function(ev) {
          var k = ev.charCode | ev.keyCode
          var s = String.fromCharCode(k).toLowerCase()
          if (s == 't') {
            topmap.zoomIn = false
          } else if (s == 'g') {
            topmap.zoomOut = false
          }
//           Event.stop(ev)
        }, false)
        window.onmousedown = function(ev) {
          down=true; return false }
        window.onmouseup = function() {
          down=false; return false  }
        window.addEventListener('mousemove', function(ev) {
          if (down) {
            Event.stop(ev)
            var dx = ev.clientX - downX
            var dy = ev.clientY - downY
            if (dx != 0 || dy != 0)
              topmap.panBy(dx,dy)
          }
          downX=ev.clientX
          downY=ev.clientY
          var x = downX
          var y = downY
          topmap.pointerX = x - topmap.container.offsetLeft
          topmap.pointerY = y - topmap.container.offsetTop
        }, false)
        createStuff = function(map, levels, x,y) {
          var maptree = new TitledPortal({
            title : x + ':' + y,
            parent : map,
            relativeZ : -2,
            left : x,
            top : y
          })
          var i = -1
          for (var y=0; y<2; y++) {
            for (var x=0; x<2; x++) {
              if (i != 2) {
                new PortalMap({
                  title : x + ':' + y,
                  parent : maptree.portal,
                  left : x*200,
                  top : y*420,
                  relativeZ : i
                })
              }
              i++
            }
          }
          if (levels > 0) {
            createStuff(maptree.portal, levels-1, 284+256, 0)
            createStuff(maptree.portal, levels-1, 284+256, 400)
            createStuff(maptree.portal, levels-1, 284+256, 800)
            createStuff(maptree.portal, levels-1, 284+522, 0)
            createStuff(maptree.portal, levels-1, 284+522, 400)
            createStuff(maptree.portal, levels-1, 284+522, 800)
          }
          return maptree
        }
        maptree = createStuff(topmap, 1,0,0)
/*        setInterval(function() {
          txt.innerHTML = 'x '+topmap.left +
                          '<br/>y '+topmap.top +
                          '<br/>left '+topmap.element.style.left +
                          '<br/>top '+topmap.element.style.top +
                          '<br/>z ' + topmap.z
        }, 50)*/
      }, false)
    </script>
  </head>
  <body bgcolor="#555555">
  </body>
</html>
